<?php
/**
 * Magento
 *
 * NOTICE OF LICENSE
 *
 * This source file is subject to the Academic Free License (AFL 3.0)
 * that is bundled with this package in the file LICENSE_AFL.txt.
 * It is also available through the world-wide-web at this URL:
 * http://opensource.org/licenses/afl-3.0.php
 * If you did not receive a copy of the license and are unable to
 * obtain it through the world-wide-web, please send an email
 * to license@magentocommerce.com so we can send you a copy immediately.
 *
 * DISCLAIMER
 *
 * Do not edit or add to this file if you wish to upgrade Magento to newer
 * versions in the future. If you wish to customize Magento for your
 * needs please refer to http://www.magentocommerce.com for more information.
 *
 * @category    design
 * @package     base_default
 * @copyright   Copyright (c) 2013 Magento Inc. (http://www.magentocommerce.com)
 * @license     http://opensource.org/licenses/afl-3.0.php  Academic Free License (AFL 3.0)
 */
?>
<?php /* @var $this Mage_Catalog_Block_Product_View_Options_Type_Select */ ?>
<?php $_option = $this->getOption() ?>
<?php $product_option_title = $option_title = strtolower(str_replace(" ", "_", $this->htmlEscape($_option->getTitle()))); ?>
<?php if ($option_title != 'size'): ?>
    <div class="option-reloaded">
<?php endif; ?>
    <dt class='<?php echo $option_title; ?>'><label<?php if ($_option->getIsRequire())
            echo ' class="required"' ?>><?php if ($_option->getIsRequire())
                echo '<em>*</em>' ?>
            <?php $lbl = $this->__($this->htmlEscape($_option->getTitle())) . "</label>" ?>
            <?php if ($option_title == 'frame'): ?>
                <span>Step 2: </span>
                <?php $lbl .= '<span class="step-selection"></span>'; ?>
            <?php elseif ($option_title == 'mat'): ?>
                <span>Step 3: </span>
                <?php $lbl .= '<span class="step-selection"></span>'; ?>
            <?php elseif ($option_title == 'borders'): ?>
                <span>Step 2: </span>
                <?php $lbl .= '<span class="step-selection"></span>'; ?>
            <?php else: ?>
                <span>Step 2: </span>
                <?php $lbl .= '<span class="step-selection">(Option selected)</span>'; ?>
            <?php endif; ?>
            <?php echo $lbl; ?>
    </dt>
    <div class="custom_options_images">
        <?php
        $_product = $this->getProduct();

        // Fame categories list
        $frame_categories = array();

        $selected_size_ui = "<div class='selected_size_ui'></div>";
        echo $selected_size_ui;

        $selected_mats_size = "<div class='selected_mats_size'></div>";
        echo $selected_mats_size;

        $custom_size_label_counter = 0;


        // Current product state
        $current_material = "<div class='current_material'></div>";
        echo $current_material;

        $current_size = "<div class='current_size'></div>";
        echo $current_size;

        $current_borders = "<div class='current_borders'></div>";
        echo $current_borders;

        $current_canvas_stretching = "<div class='current_canvas_stretching'></div>";
        echo $current_canvas_stretching;

        $current_frame = "<div class='current_frame'></div>";
        echo $current_frame;

        $current_mats = "<div class='current_mats'></div>";
        echo $current_mats;

        $option_type = $_option->getType();
        $option_title = strtolower(str_replace(" ", "_", $_option->getTitle()));
        $option_label = '';

        if ($option_title == "material") {
            $option_label = "Select Material";
        }

        if ($option_title == "size") {
            echo "<div class='size_container'>";
            echo "<div id='size_info' class='custom_option_label label_size_custom'>" . $this->__("Select Your Size (Inches):") . " <div id='size_data'></div></div>";

            $udf_limited = $_product->getAttributeText('udf_limited');

            // Custom Size is not available on Limited Edition items
            if ($udf_limited != "Yes")
                echo "<a id='custom_size_link' class='fancybox' href='#info_custom_size'>" . $this->__("Custom Size?") . "</a>";
            echo "</div>";
        }

        if ($option_title == "borders") {
            $option_label = "Select Border";
        }

        if ($option_title == "frame") {
            $option_label = "Select Frame";

            // Draw the 2 arrows that allow framing category sliding
            echo "<div id='category_frames_left_arrow_1' class='arrow_left category_framing'></div>";
            echo "<div id='category_frames_right_arrow_1' class='arrow_right category_framing'></div>";
            echo "<div id='category_frames_left_arrow_2' class='arrow_left category_framing'></div>";
            echo "<div id='category_frames_right_arrow_2' class='arrow_right category_framing'></div>";
        }

        if ($option_title == "mat") {
            $option_label = "Select Mat";
        }

        $option_label = $this->__($option_label);
        ?>

        <!-- Informational lightboxes -->
        <?php if ($option_title == "size") { echo Mage::getBlockSingleton('cms/block')->setBlockId('block_product_popup_custom_order')->toHtml(); } ?>
        <?php if ($option_title == "material"): ?>
            <div id="info_material" style="width:600px; display: none;">
                <h3>Material Options</h3>

                <p>

                <div>
                    <div class="bold">Poster</div>
                    Our Posters are high quality fine art prints that are produced using a high speed four color offset
                    lithography printing press.

                    <br/>
                    <br/>

                    This is a traditional method of printing that still utilizes individual metal plates to create the final
                    print. Today, digital technology plays an important roll in the pre-press stages of offset printing.

                    <br/>
                    <br/>

                    The results are fine art posters that very accurately reproduce the color, shading, and details of the
                    original artworks.
                </div>

                <br/>

                <div>
                    <div class="bold">Paper Substrate</div>
                    Giclées on paper are printed on high quality 275 gram satin paper. Smaller images may be printed on
                    slightly lighter weight paper.

                    <br/>
                    <br/>

                    Images printed on this bright white, ph neutral paper will resist fading for decades when framed under
                    glass and exposed to standard interior lighting.

                    <br/>
                    <br/>

                Our paper is FSC certified and produced from forests meeting the well managed criteria defined by the
                    Forest Stewardship Council.
                </div>

                <br/>

                <div>
                    <div class="bold">Canvas Substrate</div>
                    Giclées on canvas are printed on archival 365 gram poly-cotton fine art canvas. Our canvas is ph
                    neutral, acid free and has a light texture.

                    <br/>
                    <br/>

                    After printing a special coating is applied to all canvases. This clear coating provides maximum
                    protection against moisture, soiling, and staining. Images printed on this bright white canvas will
                    resist fading for decades when exposed to standard interior lighting.
                </div>
            </div>

            <!-- Informational lightboxes -->
            <?php echo Mage::getBlockSingleton('cms/block')->setBlockId('block_product_popup_materials')->toHtml(); ?>
        <?php endif; ?>

        <!-- Informational lightboxes -->
        <?php if ($option_title == "borders") { echo Mage::getBlockSingleton('cms/block')->setBlockId('block_product_popup_borders')->toHtml(); } ?>

        <!-- Informational lightboxes -->
        <?php if ($option_title == "frame") { echo Mage::getBlockSingleton('cms/block')->setBlockId('block_product_popup_frames')->toHtml(); } ?>

        <!-- Informational lightboxes -->
        <?php if ($option_title == "mat") { echo Mage::getBlockSingleton('cms/block')->setBlockId('block_product_popup_mats')->toHtml(); } ?>

        <div class="custom_option_label" id="<?php echo 'cont_' . $option_title ?>">
            <?php

            // Information light box link
            $information_lightbox = "<span class='fancybox info' rel=" . $option_title . " style='cursor: pointer'>" . "<a class=\"info_size_link fancybox fancy-$option_title\" href=\"#info_size\">(?)</a>" . "</span>";

            echo $option_label . $information_lightbox;
            ?>
        </div>

        <?php $html_mats = ''; ?>

        <?php if ($product_option_title != "mat"): ?>
        <ul id="custom_option_<?php echo $option_title; ?>">
            <?php endif; ?>

            <?php

            // Used to display the 3 mats dimensions only once in the loop
            $mats_counter = 0;
            $frameProducts = null;
            $matProducts = null;
            $values = $_option->getValues();
            //size_photopaper_oversize_ui_84_width_48_length_36
            $show_fraction = true;
            $currencySymbol = Mage::app()->getLocale()->currency(Mage::app()->getStore()->getCurrentCurrencyCode())->getSymbol();
            
            foreach ($values as $v) {
                $option_sku = $v->getData('sku');
                $fraction = $_product->getData('udf_image_size_in');
                $option_choice = $v->getData('title');
                $option_price = $v->getData('price');

                $option_name = strtolower(str_replace(" ", "_", $v->getData('title')));
                $material_name = "";


                // If the option is the size, then check if is related to paper or canvas
                if ($option_title == "size") {
                    if (strpos($option_sku, '_paper_') !== false) {
                        $material_name = "paper";
                    }

                    if (strpos($option_sku, '_canvas_') !== false) {
                        $material_name = "canvas";
                    }

                    if (strpos($option_sku, 'custom') !== false) {
                        $custom_size_label = "<li class='custom_size_label'><a href='/contact-us' target='blank'>Contact us</a> to specify your preferred height or width for the perfect fit.</li>";

                        if ($custom_size_label_counter == 0) {
                            echo $custom_size_label;
                            $custom_size_label_counter++;
                        }

                    } else {

                        $custom_size_label = "";

                        // Size initials out of the sku name
                        $size_initial = "";

                        $size_value_array = explode("_", $option_sku);

                        $is_a_number = false;

                        if (is_numeric($size_value_array[6])) {
                            $is_a_number = true;
                        }

                        $product_size = $size_value_array[6] . "&#34; x " . $size_value_array[8] . "&#34;";

                        $product_size = $this->getSize($option_sku);
                        //47&#34; x 35&#34;

                        if (is_array($product_size)) {
                            if (isset($product_size["width"], $product_size["length"])) {
                                if (strpos($option_sku, "posterpaper") && $show_fraction) {
                                    $fraction = explode(" ", $fraction);
                                    $fraction = $fraction[0] . "&#34; " . $fraction[1] . " " . $fraction[2] . " " . $fraction[3] . "&#34; " . $fraction[4];
                                    $product_size = $fraction;
                                    $size_initial = $product_size;
                                    $show_fraction = false;
                                } else {
                                    //custom_option_size_posterpaper_xl_ui_82_width_47_length_35
                                    $product_size = $product_size["width"] . "&#34; x " . $product_size["length"] . "&#34;";
                                    //47&#34; x 35&#34;
                                    $size_initial = $product_size;
                                }
                            }
                        }

                        $colon_position = strpos($option_name, ':', 1);
                        $option_name = substr($option_name, 0, $colon_position);

                        ?>
                        <?php if ($is_a_number): ?>
                            <li id="custom_option_<?php echo $option_sku; ?>"
                                class="background_border_size <?php echo $material_name; ?>">

                                <input name="size" type="radio"
                                       class="custom_option_<?php echo $option_title . "_" . $option_name; ?> custom_option_size_text"/>
                                <label for="size"><?php echo $size_initial; ?></label>
                            </li>
                        <?php endif; ?>
                    <?php
                    }

                } else if ($option_title == "frame") {
                    // Get the framing product by sku. Every other related information can be extracted from this product.
                    if (!isset($frameProducts)) {
                        $frameProducts = $this->loadProductsByOptionSkus(array('udf_framecat', 'udf_moulding_width', 'udf_f_m_avail_4_paper', 'udf_f_m_avail_4_canvas', 'udf_fmaxslsin', 'udf_fmaxsssin'));
                    }

                    // The frame item number is uppercase
                    $frame_item_number = strtoupper($option_sku);
                    $frame_title = $option_choice;

                    $lSku = strtolower($option_sku);

                    if (isset($frameProducts[$lSku])) {
                        $category_name = $frameProducts[$lSku]->getUdfFramecat();
                        $frame_size = $frameProducts[$lSku]->getUdfMouldingWidth();
                        $frame_available_4_paper = $frameProducts[$lSku]->getAttributeText('udf_f_m_avail_4_paper');
                        $frame_available_4_canvas = $frameProducts[$lSku]->getAttributeText('udf_f_m_avail_4_canvas');
                        $frame_maximum_long_side = $frameProducts[$lSku]->getUdfFmaxslsin();
                        $frame_maximum_short_side = $frameProducts[$lSku]->getUdfFmaxsssin();
                    } else {
                        $category_name = '';
                        $frame_size = '';
                        $frame_available_4_paper = '';
                        $frame_available_4_canvas = '';
                        $frame_maximum_long_side = '';
                        $frame_maximum_short_side = '';
                    }

                    // Add each frame category name to an array, to be used later to dynamically build the dropdown of categories
                    if (!in_array($category_name, $frame_categories)) {
                        array_push($frame_categories, $category_name);
                    }

                    if ($option_sku == "frame_none") {
                        $frame_item_number = "";
                    }

                    $framing_profile_url = "http://d3odr912zwpuhm.cloudfront.net/icons/framing_profiles/";
                    $framing_corner_url = "http://d3odr912zwpuhm.cloudfront.net/icons/framing_corners/";
                    ?>

                    <li id="<?php echo $option_sku; ?>" class="background_border custom_option_viewport"
                        data-frame_category="<?php echo $category_name; ?>"
                        style="background-image: url('<?php echo $framing_profile_url . $frame_item_number . ".png"; ?>')"
                        data-frame_size="<?php echo $frame_size; ?>"
                        data-frame_available_4_paper="<?php echo $frame_available_4_paper; ?>"
                        data-frame_available_4_canvas="<?php echo $frame_available_4_canvas; ?>"
                        data-frame_maximum_long_side="<?php echo $frame_maximum_long_side; ?>"
                        data-frame_maximum_short_side="<?php echo $frame_maximum_short_side; ?>">
                        <div class="frame_description">
                            <div class="frame_title"><?php echo $this->__($frame_title); ?></div>
                            <div class="frame_price"><?php echo $this->__('Add') . ' ' . $currencySymbol ?>
                                <div class="frame_real_price">
                                    0.00
                                </div>
                                <div class="frame_ui_price">
                                    <?php echo number_format((float)$option_price, 2, '.', ''); ?>
                                </div>
                            </div>
                        </div>
                        <div id="custom_option_<?php echo $option_sku; ?>_corner_image" class="frame_corner_image"
                             style="background-image: url('<?php echo $framing_corner_url . $frame_item_number . ".png"; ?>')">
                        </div>
                    </li>
                    <select class="frame_categories">
                        <?php
                        $i = 0;
                        // Dynamically build the list of frame categories
                        foreach ($frame_categories as $category_name) {
                            // Rename each category name that will be displayed, except for the first one i.e. "No Frame"
                            if ($i > 0) {
                                $category_name_displayed = ucfirst($category_name);
                            } else {
                                $category_name = "no_frame";
                                $category_name_displayed = "No Frame";
                            }
                            ?>
                            <option value=<?php echo $category_name; ?>><?php echo $this->__($category_name_displayed); ?></option>

                            <?php
                            $i++;
                        }
                        ?>
                    </select>
                <?php
                } else if ($option_title == "mat") {
                    // Get the framing product by sku. Every other related information can be extracted from this product.
                    if (!isset($matProducts)) {
                        $matProducts = $this->loadProductsByOptionSkus(array('udf_framecat', 'udf_colorcode', 'udf_moulding_width', 'udf_f_m_avail_4_paper', 'udf_f_m_avail_4_canvas', 'udf_fmaxslsin', 'udf_fmaxsssin'));
                    }

                    $lSku = strtolower($option_sku);

                    if (isset($matProducts[$lSku])) {
                        $mats_sku = strtolower($matProducts[$lSku]->getSku());
                        $category_name = $matProducts[$lSku]->getUdfFramecat();
                        $mats_color_code = $matProducts[$lSku]->getUdfColorcode();
                        $mats_size = $matProducts[$lSku]->getUdfMouldingWidth();
                        $mat_available_4_paper = $matProducts[$lSku]->getAttributeText('udf_f_m_avail_4_paper');
                        $mat_available_4_canvas = $matProducts[$lSku]->getAttributeText('udf_f_m_avail_4_canvas');
                        $mat_maximum_long_side = $matProducts[$lSku]->getUdfFmaxslsin();
                        $mat_maximum_short_side = $matProducts[$lSku]->getUdfFmaxsssin();
                    } else {
                        $mats_sku = '';
                        $category_name = '';
                        $mats_color_code = '';
                        $mats_size = '';
                        $mat_available_4_paper = '';
                        $mat_available_4_canvas = '';
                        $mat_maximum_long_side = '';
                        $mat_maximum_short_side = '';
                    }

                    // Mats color for each choice
                    $html_mats .= '
                    <li id="' . $option_sku . '" class="mats_color"
                        style="background-color: ' . $mats_color_code . ';"
                        data-mat_category="' . $category_name . '" data-mats_sku="' . $mats_sku . '"
                        data-mats_size="' . $mats_size . '"
                        data-mat_available_4_paper="' . $mat_available_4_paper . '"
                        data-mat_available_4_canvas="' . $mat_available_4_canvas . '"
                        data-mat_maximum_long_side="' . $mat_maximum_long_side . '"
                        data-mat_maximum_short_side="' . $mat_maximum_short_side . '">
                        <div class="mats_ui_price">
                            ' . number_format((float)$option_price, 2, ".", "") . '
                        </div>
                    </li>';
                }
            }
            ?>
            <?php if ($product_option_title != "mat"): ?>
        </ul>
    <?php endif; ?>
    </div>
    <dd class='<?php echo $product_option_title; ?>'<?php if ($_option->decoratedIsLast) { ?> class="last"<?php } ?>
        data-option-title="<?php echo $product_option_title; ?>">
        <div class="input-box">
            <?php echo $this->getValuesHtml() ?>
            <?php if ($_option->getIsRequire()): ?>
                <?php if ($_option->getType() == Mage_Catalog_Model_Product_Option::OPTION_TYPE_RADIO || $_option->getType() == Mage_Catalog_Model_Product_Option::OPTION_TYPE_CHECKBOX): ?>
                    <span id="options-<?php echo $_option->getId() ?>-container"></span>
                <?php endif; ?>
            <?php endif; ?>
        </div>
    </dd>

<?php if ($product_option_title == "mat") { ?>
    <div class="custom_options_images">
        <div id='available_mats' class='custom_option_label label_mat_custom'>Available mats</div>
        <div id='mats_line'></div>
        <ul id="custom_option_<?php echo $product_option_title; ?>"><?php echo $html_mats; ?></ul>
    </div>
<?php } ?>


<?php if ($option_title != 'size'): ?>
    </div>
<?php endif; ?>
